---
title: 'M2-3: Advanced network analysis'
author: "Daniel S. Hain (dsh@business.aau.dk)"
date: "Updated `r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: true
    toc_depth: 2
    toc_float:
      collapsed: false
    theme: flatly
---

```{r setup, include=FALSE}
### Generic preamble
Sys.setenv(LANG = "en") # For english language
options(scipen = 5) # To deactivate annoying scientific number notation
set.seed(1337) # To have a seed defined for reproducability

### Knitr options
if (!require("knitr")) install.packages("knitr"); library(knitr) # For display of the markdown
knitr::opts_chunk$set(warning=FALSE,
                     message=FALSE,
                     fig.align="center"
                     )

### Install packages if necessary
if (!require("pacman")) install.packages("pacman") # package for loading and checking packages :)
pacman::p_load(tidyverse, # Standard datasciewnce toolkid (dplyr, ggplot2 et al.)
               magrittr, # For advanced piping (%>% et al.)
               igraph, # For network analysis
               tidygraph, # For tidy-style graph manipulation
               ggraph, # For ggplot2 style graph plotting
               Matrix, # For matrix tooling
               bibliometrix, # for bibliometric analysis
               data.table # for fast data manipulation
               )
```

# Introduction

# Types of networks



## Similarity networks

```{r}
cars_pca <- mtcars[,c(1:7,10,11)] %>% 
  drop_na() %>%
  prcomp(center = TRUE , scale = TRUE)
```

```{r}
cars_dist <- cars_pca$x %>% dist(method = "euclidean") 
```

```{r}
g <- cars_dist %>% 
  as.matrix() %>%
  as_tbl_graph() 
```

```{r}
g <- g %E>%
  mutate(weight = max(weight) - weight) %>%
  filter(weight >= weight %>% quantile(0.75)) %N>%
  filter(!node_is_isolated()) 
```


```{r}
g %>% ggraph(layout = "kk") + 
  geom_node_point() + 
  geom_edge_link(aes(size = weight), alpha = 0.25) +
  geom_node_text(aes(label = name)) +
  theme_graph()
```


## Hirarchies

```{r}
cars_hc <- cars_dist %>%
  hclust(method = "ward.D2")
```

```{r}
g <- cars_hc %>% as_tbl_graph()
```

```{r}
g %>% ggraph(layout = 'dendrogram') + 
  geom_edge_diagonal() +
  geom_node_point() +
  theme_graph()
```




# Network Visualization

## Visualize what, and why?

The main concern in designing a network visualization is the purpose it has to serve. What are the structural properties that we want to highlight? What are the key concerns we want to address?

![](https://www.dropbox.com/s/p34n0m16qx1hnhz/networks_viz_goal.png?dl=1){width=500px}

Network maps are far from the only visualization available for graphs - other network representation formats, and even simple charts of key characteristics, may be more appropriate in some cases.

![](https://www.dropbox.com/s/l7rb0v9h95jmqen/networks_viz_type.png?dl=1){width=500px}

In network maps, as in other visualization formats, we have several key elements that control the outcome. The major ones are color, size, shape, and position.

![](https://www.dropbox.com/s/da8n7n3gp48s2iu/networks_viz_controls.png?dl=1){width=500px}


## Node Visualization

```{r}
g <- as_tbl_graph(highschool, directed = TRUE)
```

```{r,warning=FALSE, message=FALSE, error=FALSE}
p_load(randomNames)

g <- g %E>%
  mutate(weight = sample(1:5, n(), replace = TRUE),
         year = year %>% as.factor()) %N>%
  mutate(class = sample(LETTERS[1:3], n(), replace = TRUE),
         gender = rbinom(n = n(), size = 1, prob = 0.5) %>% as.logical(),
         label = randomNames(gender = gender, name.order = "first.last"),
         cent_dgr = centrality_degree(mode = "in"),
         community = group_edge_betweenness(weights = weight, directed = TRUE) %>% as.factor()) %N>%
  filter(!node_is_isolated()) %E>%
  mutate(community_from = .N()$community[from])
```



```{r}
set.seed(1337)

g %>%
  ggraph(layout = "nicely") + 
    geom_point(aes(x = x, y = y))
```

```{r}
g %>% create_layout(layout = "nicely") %>% head()
```

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_node_point()
```

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_node_point() + 
  geom_edge_link(alpha = 0.25) 
```



```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_link(alpha = 0.25) +
  geom_node_point(aes(size = cent_dgr)) 
```




```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_link(alpha = 0.25) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community)) 
```



```{r}
shapes()
```



```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_link(alpha = 0.25) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender)) +
  theme_graph() 
```

## Edge Visualization

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_link(aes(size = weight), alpha = 0.25) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_link(aes(size = weight,
                     color = year), alpha = 0.5) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_fan(aes(size = weight,
                     color = year), alpha = 0.25) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_link(alpha = 0.1) +
  geom_edge_density(aes(fill = year)) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```

Directionality

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_fan(aes(size = weight,
                     color = year), alpha = 0.5) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```


```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_fan(aes(size = weight,
                     color = year %>% as.factor()), alpha = 0.5) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_fan(aes(size = weight,
                    color = year,
                    shape = year), alpha = 0.5) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```

```{r}
g %>% ggraph(layout = 'nicely') + 
  geom_edge_fan(aes(size = weight,
                    color = year,
                    shape = year), 
                arrow = arrow(type = "closed", length = unit(2, "mm")),
                start_cap = circle(1, "mm"),
                end_cap = circle(1, "mm"),
                alpha = 0.5) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() 
```


```{r}
g %>%
  ggraph(layout = 'nicely') + 
  geom_edge_fan(aes(size = weight,
                    color = community_from,
                    shape = year,
                    alpha = stat(index))
                ) +
  geom_node_point(aes(size = cent_dgr, 
                      color = community,
                      shape = gender),
                  show.legend = FALSE) +
  theme_graph() + 
  scale_edge_alpha("Edge direction", guide = "edge_direction")
```


## Layouts

### Ordinary graph style

```{r, fig.height=10, fig.width= 20}
pacman::p_load(ggpubr)
layout_list <- c("randomly", "circle", "grid", "fr", "kk")

g_list <- list(NULL)
for(i in 1:length(layout_list)){
  g_list[[i]] <-g %>% 
    ggraph(layout = layout_list[i]) + 
    geom_edge_fan(aes(size = weight)) +
    geom_node_point(aes(size = cent_dgr, 
                        color = community),
                    show.legend = FALSE) +
    theme_graph() +
    labs(title = paste("Layout:", layout_list[i], sep = " "))
}

ggarrange(plotlist = g_list, nrow = 2, ncol = 3, common.legend = TRUE, legend = "bottom")

```



### Hive plots

A hive plot, while still technically a node-edge diagram, is a bit different from the rest as it uses information pertaining to the nodes, rather than the connection information in the graph. This means that hive plots, to a certain extent are more interpretable as well as less vulnerable to small changes in the graph structure. They are less common though, so use will often require some additional explanation.

```{r}
g %>%
  ggraph(layout = "hive", axis = "community") + 
  geom_edge_hive(aes(colour = factor(year))) + 
  geom_axis_hive(aes(colour = community), size = 2, label = FALSE) + 
  coord_fixed() +
  theme_graph()
```


### Hirarchies


### Heatmaps







# Multi-Modal Networks

Now its time to talk about an interesting type of networks, multi-modal. This means, a network has several "modes", meaning connects entities on different conceptual levels. The most commone one is a **2-mode** (or **bipartite**) network. Examples could be an Author $\rightarrow$ Paper, Inventor $\rightarrow$ Patent, Member $\rightarrow$ Club network. Here, the elements in the different modes represent different things. 

We can alalyse them in sepperation (and sometimes we should), but often its helpful to "project"" them onto one mode. Here, we create a node in one mode by joint association with another mode.

![](https://www.dropbox.com/s/e4vnq7kh24pyu0t/networks_2mode.png?dl=1{width=500px}

While that sounds simple, it can be a very powerful technique, as I will demonstrate now.

#

```{r}
data <- whigs %>% as_tibble()
```

```{r}
data %>% head()
```










# Case study: Bibliographic networks

## Basics

Lets talk about bibliographic networks. In short, that are networks between documents which cite each others. That can be (commonly) academic publications, but also patents or policy reports. Conceptually, we can see them as 2 mode networks, between articles and their reference. That helps us to apply some interesting metrics, such as:

* direct citations
* Bibliographic coupling
* Co--citations

Interestingly, different projections of this 2-mode network give the whole resulting 1-mode network a different meaning.

![](https://www.dropbox.com/s/f8g8nr83lucvpqx/networks_biblio.png?dl=1){width=500px}


I will illustrate more in detail in the following. The example is absed on some own work.[^1]

## Doing it by hand

Lets imagine we do it the hard way. We download some bibliographic data, and have to do all the munging on our own, till we end up with a nice network representation. Lets go through some of these steps together.

Lets get started. I will load some bibliographic data (selection process explained in the paper) on articles concerned with the field of "Innovation Studies". It already went through some upfront cleaning, but is very similar to what you get when you download data from WoS.

```{r}
rm(list=ls())
articles <- readRDS(url("https://www.dropbox.com/s/oumm3n0km316im4/publications.RDS?dl=1"))
```

```{r}
articles %<>%
  select(SR, AU, TI, JI, PY, AU_UN, DE, TC, NR, CR) %>%
  rename(article = SR,
         author = AU,
         title = TI,
         journal = JI,
         year = PY,
         affiliation = AU_UN,
         keywords = DE,
         citations = TC,
         references = NR,
         reference.list = CR)
```


```{r}
articles %>%
  arrange(desc(citations)) %>%
  glimpse()
```


So, where are the links to the references? Its a bit messy, they are all found in the `CRF` field, sepperated by `;`.

```{r}
articles[1, "reference.list"]
```

I will now transfere them to an article $\rightarrow$ reference edgelist. Since its a lot of data, I will here use the `data.table` package functionality. I usually avoid it, because I hate the syntax. However, its just way faster, and when working with large bibliometric corpus that matters.


```{r}
citation.el <- data.table(article = articles$article, 
                          str_split_fixed(articles$reference.list, ";", max(articles$references, na.rm=T))) 

citation.el <- melt(citation.el, id.vars = "article")[, variable:= NULL][value!=""]

citation.el %<>%
  rename(reference = value) %>%
  arrange(article,reference)
```

```{r}
citation.el %>% head()
```



Likewise, I will transfer this into a sparse 2-mode matrix. I amke it sparse because its way more efficient.

```{r}
library(Matrix)
mat <- spMatrix(nrow=length(unique(citation.el$article)),
                ncol=length(unique(citation.el$reference)),
                i = as.numeric(factor(citation.el$article)),
                j = as.numeric(factor(citation.el$reference)),
                x = rep(1, length(as.numeric(citation.el$article))) ) 
row.names(mat) <- levels(factor(citation.el$article))
colnames(mat) <- levels(factor(citation.el$reference))

str(mat)
```







## Your turn

Finally, its again time for you to have some fun. Check out this final exercise: [here](https://www.kaggle.com/danielhain/sds-2018-m2-3-nw-exercise-1).


# Endnotes

### References

[^1]: Rakas, M., & Hain, D. S. (2019). The state of innovation system research: What happens beneath the surface?. Research Policy, 45 (9). DOI: https://doi.org/10.1016/j.respol.2019.04.011


### More info
You can find more info about:

* `tidygraph` [here](https://tidygraph.data-imaginist.com/)
* `ggraph` [here](https://ggraph.data-imaginist.com/)
* `bibliometrix` [here](http://www.bibliometrix.org/)
* `TidyScientometrix` [here](https://github.com/daniel-hain/TidyScientometrix)


### Session info
```{r}
sessionInfo()
```

